rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---- Helper: Super Admin ----
    function isSuperAdmin() {
      return request.auth != null &&
             request.auth.token.email in [
               'henrique.peixoto@3ainvestimentos.com.br',
               'matheus@3ainvestimentos.com.br',
               'desenvolvedor@3ariva.com.br' ,
              'dalcion.franco@3ainvestimentos.com.br',
								'ti@3ariva.com.br'
             ];
    }
    
    // ---- Helper: Normalizar Email (NOVO E NECESSÁRIO) ----
    // Replica a lógica do seu frontend para normalizar e-mails
    function normalizeEmail(email) {
      // split() e size SÃO válidos
      let parts = email.split('@');
      
      // Lógica ternária (if/else em uma linha):
      // SE ( email tem 2 partes E a parte 2 é '3ariva.com.br' )
      // ENTÃO ( ? ) retorne 'parte1' + '@3ainvestimentos.com.br'
      // SENÃO ( : ) retorne o email original
      return parts.size() == 2 && parts[1] == '3ariva.com.br' ?
             parts[0] + '@3ainvestimentos.com.br' :
             email;
    }

    // ---- Helper: o usuário está mexendo no próprio registro?
    // cobre os dois padrões de ID: UID e email
    function isSelf() {
      return request.auth != null &&
             (request.resource.data.authUid == request.auth.uid ||
              normalizeEmail(request.auth.token.email) == normalizeEmail(resource.data.email)
    );
    }

    // =========================
    // systemSettings
    // =========================
    match /systemSettings/{docId} {
      // público_config é público
      allow read: if docId == 'public_config';
      allow write: if docId == 'public_config' && isSuperAdmin();

      // leitura pública temporária de 'config'
      allow read: if docId == 'config';
      allow write: if docId == 'config' && isSuperAdmin();

      // admin_config: só ler autenticado, ninguém escreve via client
      allow read: if docId == 'admin_config' && request.auth != null;
      allow write: if docId == 'admin_config' && false;

      // keys: só autenticado pode ler/escrever
      allow read: if docId == 'keys' && request.auth != null;
      allow write: if docId == 'keys' && request.auth != null;
    }

    // =========================
    // collaborators
    // =========================
    match /collaborators/{userId} {
      // qualquer logado pode ler
      allow read: if request.auth != null;

      // criar:
      // - o próprio usuário pode criar/atualizar o próprio doc
      // - super admin pode criar pra qualquer um
      allow create: if isSelf() || isSuperAdmin();

      // atualizar:
      // - o próprio usuário OU super admin
      allow update: if isSuperAdmin() || 
      (request.auth.uid == resource.data.authUid) || 
      normalizeEmail(request.auth.token.email) == normalizeEmail(resource.data.email);

      // deletar: só super admin
      allow delete: if isSuperAdmin();
    }

    // =========================
    // collaborator_logs
    // =========================
    match /collaborator_logs/{logId} {
      // só super admin pode ler logs
      allow read: if isSuperAdmin();

      // qualquer logado pode criar log (ex: registrar login)
      allow create: if request.auth != null;

      // alterar/apagar só super admin
      allow update, delete: if isSuperAdmin();
    }

    // =========================
    // contacts
    // =========================
    match /contacts/{document=**} {
      // liberar leitura pros usuários autenticados (necessário pro onSnapshot)
      allow read: if request.auth != null;

      // escrita só por super admin
      allow write: if isSuperAdmin();
    }

    // =========================
    // Conteúdo geral
    // =========================
    match /newsItems/{document=**} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    match /documents/{document=**} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    match /labs/{document=**} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    match /messages/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /quickLinks/{document=**} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    match /rankings/{document=**} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    match /polls/{pollId}/{document=**} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if isSuperAdmin();
    }

    match /idleFabMessages/{document=**} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }

    // =========================
    // workflows
    // =========================
    match /workflows/{document=**} {
      allow read, write: if true;
    }

    // =========================
    // workflowDefinitions / workflowAreas
    // =========================
    match /workflowDefinitions/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /workflowAreas/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // =========================
    // counters
    // =========================
    match /counters/{document=**} {
      allow read, write: if true;
    }

    // =========================
    // audit_logs
    // =========================
    match /audit_logs/{logId} {
      allow create: if request.auth != null;
      allow read, update, delete: if isSuperAdmin();
    }

    // =========================
    // fabMessages
    // =========================
    match /fabMessages/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if isSuperAdmin();
    }

    // =========================
    // meeting_analyses
    // =========================
    match /meeting_analyses/{analysisId} {
      // Leitura: apenas se o user_email do documento corresponde ao email do usuário logado
      // Comparação direta, SEM normalização (conforme especificado)
      allow read: if request.auth != null && 
                     resource.data.user_email == request.auth.token.email;
      
      // Escrita: apenas super admin (o backend escreve via admin SDK)
      allow write: if isSuperAdmin();
    }
  }
}
